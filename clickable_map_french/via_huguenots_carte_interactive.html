<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive - Via Huguenots</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Open Sans', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .map-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #5d9ace;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            margin-bottom: 20px;
            text-align: center;
        }

        .interactive-map {
            position: relative;
            width: 100%;
            max-width: 1170px;
            margin: 0 auto;
        }

        .interactive-map img {
            width: 100%;
            height: auto;
            display: block;
        }

        .interactive-map svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .stage-marker {
            pointer-events: all;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Type-specific colors with transparency */
        .stage-marker.stage circle {
            fill: #ff6b6b;
            stroke: white;
            stroke-width: 2;
            opacity: 0.5;
        }

        .stage-marker.alternative circle {
            fill: #FF9800;
            stroke: white;
            stroke-width: 2;
            opacity: 0.5;
        }

        .stage-marker.urban circle {
            fill: #2196F3;
            stroke: white;
            stroke-width: 2;
            opacity: 0.5;
        }

        .stage-marker.special circle {
            fill: #9C27B0;
            stroke: white;
            stroke-width: 2;
            opacity: 0.5;
        }

        .stage-marker.regional rect {
            fill: #4CAF50;
            stroke: white;
            stroke-width: 2;
            opacity: 0.5;
        }

        .stage-marker:hover circle,
        .stage-marker:hover rect {
            opacity: 0.8;
        }

        .stage-marker text {
            fill: white;
            font-size: 10px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }

        .connection-line {
            stroke-width: 2;
            opacity: 0.4;
            pointer-events: none;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
            max-width: 300px;
            white-space: nowrap;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip .stage-name {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .tooltip .stage-name.stage {
            color: #ff6b6b;
        }

        .tooltip .stage-name.alternative {
            color: #FF9800;
        }

        .tooltip .stage-name.urban {
            color: #2196F3;
        }

        .tooltip .stage-name.special {
            color: #9C27B0;
        }

        .tooltip .stage-name.regional {
            color: #4CAF50;
        }

        .tooltip .stage-distance {
            font-size: 12px;
            color: #ccc;
        }

        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 14px;
        }

        .legend h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            margin: 5px 15px 5px 0;
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 8px;
            opacity: 0.7;
        }

        .legend-rect {
            width: 18px;
            height: 12px;
            margin-right: 8px;
            opacity: 0.7;
        }

        .legend-stage {
            background-color: #ff6b6b;
        }

        .legend-alternative {
            background-color: #FF9800;
        }

        .legend-urban {
            background-color: #2196F3;
        }

        .legend-special {
            background-color: #9C27B0;
        }

        .legend-regional {
            background-color: #4CAF50;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .map-container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .stage-marker text {
                font-size: 10px;
            }

            .tooltip {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="map-container">
        <h1>Carte Interactive - Via Huguenots en Suisse</h1>
        
        <div class="interactive-map" id="mapContainer">
            <img src="map_chemin_layer.jpg" alt="Carte Via Huguenots" id="mapImage">
            <svg id="mapSvg" viewBox="0 0 1170 705" preserveAspectRatio="xMidYMid meet">
                <!-- Les marqueurs seront ajoutés ici par JavaScript -->
            </svg>
        </div>

        <div class="tooltip" id="tooltip">
            <span class="stage-name"></span>
            <span class="stage-distance"></span>
        </div>

        <div class="legend">
            <h3>Légende</h3>
            <div class="legend-item">
                <div class="legend-dot legend-stage"></div>
                <span>Étapes</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-alternative"></div>
                <span>Alternatives</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-urban"></div>
                <span>Urbains</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot legend-special"></div>
                <span>Spéciaux</span>
            </div>
            <div class="legend-item">
                <div class="legend-rect legend-regional"></div>
                <span>Régionaux</span>
            </div>
            <p style="margin-top: 10px; font-style: italic; color: #666;">
                Cliquez sur un point pour accéder aux détails de l'étape
            </p>
        </div>
    </div>

    <script>
        // Configuration des couleurs par type
        const typeColors = {
            'stage': '#ff6b6b',
            'alternative': '#FF9800',
            'urban': '#2196F3',
            'special': '#9C27B0',
            'regional': '#4CAF50'
        };

        // Charger les données depuis le JSON
        fetch('via_huguenots_merged.json')
            .then(response => response.json())
            .then(stages => {
                initMap(stages);
            })
            .catch(error => {
                console.error('Erreur de chargement des données:', error);
            });

        function initMap(stages) {
            const svg = document.getElementById('mapSvg');
            const tooltip = document.getElementById('tooltip');

            if (!svg || !tooltip) return;

            // Calculer la position d'affichage du marqueur (avec offset si nécessaire)
            function calculateMarkerPosition(stage) {
                if (!stage.offset_distance || stage.offset_distance === 0) {
                    return { x: stage.x, y: stage.y };
                }
                const angleRad = (stage.offset_angle || 0) * Math.PI / 180;
                const offsetX = stage.offset_distance * Math.cos(angleRad);
                const offsetY = -stage.offset_distance * Math.sin(angleRad);
                return {
                    x: stage.x + offsetX,
                    y: stage.y + offsetY
                };
            }

            // Créer les lignes de connexion pour les marqueurs avec offset
            stages.forEach((stage) => {
                if (stage.offset_distance && stage.offset_distance > 0) {
                    const markerPos = calculateMarkerPosition(stage);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.classList.add('connection-line');
                    line.setAttribute('x1', stage.x);
                    line.setAttribute('y1', stage.y);
                    line.setAttribute('x2', markerPos.x);
                    line.setAttribute('y2', markerPos.y);
                    line.setAttribute('stroke', typeColors[stage.type] || '#999');
                    svg.appendChild(line);
                }
            });

            // Créer les marqueurs pour chaque étape
            stages.forEach((stage) => {
                const markerPos = calculateMarkerPosition(stage);
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.classList.add('stage-marker', stage.type);
                group.setAttribute('data-stage-id', stage.id);

                // Créer un rectangle pour les routes régionales, un cercle pour les autres
                if (stage.type === 'regional') {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', markerPos.x - 25);
                    rect.setAttribute('y', markerPos.y - 10);
                    rect.setAttribute('width', '50');
                    rect.setAttribute('height', '20');
                    rect.setAttribute('rx', '3');
                    group.appendChild(rect);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', markerPos.x);
                    text.setAttribute('y', markerPos.y);
                    text.textContent = 'REG';
                    group.appendChild(text);
                } else {
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', markerPos.x);
                    circle.setAttribute('cy', markerPos.y);
                    circle.setAttribute('r', '10');
                    group.appendChild(circle);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', markerPos.x);
                    text.setAttribute('y', markerPos.y);
                    text.textContent = stage.id;
                    group.appendChild(text);
                }

                svg.appendChild(group);

                // Événements
                group.addEventListener('click', () => {
                    window.location.href = stage.url_fr;
                });

                group.addEventListener('mouseenter', (e) => {
                    const nameSpan = tooltip.querySelector('.stage-name');
                    nameSpan.textContent = stage.name_full_fr;
                    nameSpan.className = 'stage-name ' + stage.type;
                    tooltip.querySelector('.stage-distance').textContent = stage.distance || '';
                    tooltip.classList.add('show');
                    updateTooltipPosition(e);
                });

                group.addEventListener('mousemove', updateTooltipPosition);

                group.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
            });

            function updateTooltipPosition(e) {
                const x = e.clientX;
                const y = e.clientY;
                tooltip.style.left = (x + 15) + 'px';
                tooltip.style.top = (y - 10) + 'px';
            }

            // Responsive: ajuster le SVG quand l'image change de taille
            window.addEventListener('resize', () => {
                const img = document.getElementById('mapImage');
                const svg = document.getElementById('mapSvg');
                svg.setAttribute('viewBox', `0 0 1170 705`);
            });
        }
    </script>
</body>
</html>
